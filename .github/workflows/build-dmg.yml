name: Build Swift App

on:
  push:
    branches: [ main, swifty ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, swifty ]

jobs:
  build-swift-app:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Build Swift app
      working-directory: MCPServerManager
      run: |
        # Build for native architecture
        swift build -c release

        # Verify binary was created
        ls -la .build/release/
        file .build/release/MCPServerManager

    - name: Create app bundle
      working-directory: MCPServerManager
      run: |
        # Create .app structure
        mkdir -p build/MCP-Server-Manager.app/Contents/MacOS
        mkdir -p build/MCP-Server-Manager.app/Contents/Resources

        # Copy binary
        cp .build/release/MCPServerManager build/MCP-Server-Manager.app/Contents/MacOS/

        # Copy app icon
        cp icons/AppIcon.icns build/MCP-Server-Manager.app/Contents/Resources/AppIcon.icns

        # Create Info.plist
        cat > build/MCP-Server-Manager.app/Contents/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>MCPServerManager</string>
            <key>CFBundleIdentifier</key>
            <string>com.mcpmanager.app</string>
            <key>CFBundleName</key>
            <string>MCP Server Manager</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>2.0.2.${{ github.run_number }}</string>
            <key>CFBundleVersion</key>
            <string>${{ github.run_number }}</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>CFBundleIconFile</key>
            <string>AppIcon</string>
            <key>SUFeedURL</key>
            <string>https://github.com/${{ github.repository }}/releases/download/latest/appcast.xml</string>
            <key>SUPublicEDKey</key>
            <string>SnkRxHZxaHrqHMoSW/Ls6dbeqZaGZBlS5AQ9I8OE3JI=</string>
            <key>SUEnableAutomaticChecks</key>
            <true/>
            <key>SUAutomaticallyUpdate</key>
            <false/>
            <key>SUAllowsAutomaticUpdates</key>
            <true/>
        </dict>
        </plist>
        EOF

    - name: Import certificates
      env:
        MAC_APP_STORE_CERT: ${{ secrets.MAC_APP_STORE_CERT }}
        MAC_INSTALLER_CERT: ${{ secrets.MAC_INSTALLER_CERT }}
        MAC_CERTS: ${{ secrets.MAC_CERTS }}
        CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
      run: |
        # Create temporary keychain
        security create-keychain -p actions build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p actions build.keychain
        security set-keychain-settings -t 3600 -u build.keychain

        # Decode and import Developer ID certificates (MAC_CERTS - likely contains Developer ID Application)
        if [ -n "$MAC_CERTS" ]; then
          echo "$MAC_CERTS" | base64 --decode > developer_id_cert.p12
          security import developer_id_cert.p12 -k build.keychain -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign -A || \
            security import developer_id_cert.p12 -k build.keychain -P "" -T /usr/bin/codesign -T /usr/bin/productsign -A
          rm developer_id_cert.p12
        fi

        # Decode and import App Store signing certificate
        if [ -n "$MAC_APP_STORE_CERT" ]; then
          echo "$MAC_APP_STORE_CERT" | base64 --decode > appstore_cert.p12
          # Try with password first, then without if it fails
          security import appstore_cert.p12 -k build.keychain -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign -A || \
            security import appstore_cert.p12 -k build.keychain -P "" -T /usr/bin/codesign -T /usr/bin/productsign -A
          rm appstore_cert.p12
        fi

        # Decode and import Installer certificate
        if [ -n "$MAC_INSTALLER_CERT" ]; then
          echo "$MAC_INSTALLER_CERT" | base64 --decode > installer_cert.p12
          security import installer_cert.p12 -k build.keychain -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign -A || \
            security import installer_cert.p12 -k build.keychain -P "" -T /usr/bin/codesign -T /usr/bin/productsign -A
          rm installer_cert.p12
        fi

        # Set partition list
        security set-key-partition-list -S apple-tool:,apple:,codesign:,productsign: -s -k actions build.keychain

        # Verify certificates
        echo "Imported certificates:"
        security find-identity -v -p codesigning

    - name: Sign app bundle
      working-directory: MCPServerManager
      env:
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        # Find the signing identity
        echo "Available signing identities:"
        security find-identity -v -p codesigning

        # Get the first valid Developer ID or Mac App Store certificate
        # Prefer Developer ID Application for direct distribution, but accept App Store certs as fallback
        IDENTITY=$(security find-identity -v -p codesigning | grep -E "Developer ID Application|Apple Distribution|3rd Party Mac Developer Application" | head -1 | awk -F'"' '{print $2}')

        if [ -z "$IDENTITY" ]; then
          echo "❌ No valid signing identity found"
          echo "⚠️  App will not be signed - may show 'damaged' error on macOS"
          exit 0
        fi

        echo "Signing with identity: $IDENTITY"

        # Sign the app bundle with hardened runtime
        # Note: Using relaxed entitlements for direct distribution (DMG)
        # App Store builds should NOT use these entitlements
        codesign --force --deep --sign "$IDENTITY" \
          --options runtime \
          --entitlements ../entitlements.plist \
          --timestamp \
          build/MCP-Server-Manager.app || {
            echo "⚠️  Signing with entitlements failed, trying without..."
            codesign --force --deep --sign "$IDENTITY" \
              --options runtime \
              --timestamp \
              build/MCP-Server-Manager.app
          }

        # Verify the signature
        echo "Verifying signature..."
        codesign --verify --verbose build/MCP-Server-Manager.app
        echo "✓ App bundle signed successfully"

    - name: Install create-dmg tool
      run: brew install create-dmg

    - name: Install Sparkle tools
      run: |
        # Download and install Sparkle's generate_appcast tool
        curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.5.2/Sparkle-2.5.2.tar.xz -o sparkle.tar.xz
        tar -xf sparkle.tar.xz
        chmod +x bin/generate_appcast
        sudo cp bin/generate_appcast /usr/local/bin/

    - name: Create DMG
      working-directory: MCPServerManager
      run: |
        # Create installer DMG with Applications symlink
        VERSION="2.0.2.${{ github.run_number }}"
        bash ../create-dmg.sh build/MCP-Server-Manager.app "build/MCP-Server-Manager-v${VERSION}.dmg"

        # Also create a "latest" symlink for consistent naming
        cd build
        ln -sf "MCP-Server-Manager-v${VERSION}.dmg" MCP-Server-Manager.dmg

    - name: Notarize and staple DMG
      continue-on-error: true
      working-directory: MCPServerManager
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        VERSION="2.0.2.${{ github.run_number }}"
        DMG_PATH="build/MCP-Server-Manager-v${VERSION}.dmg"

        if [ -z "$APPLE_ID" ] || [ -z "$APPLE_APP_SPECIFIC_PASSWORD" ]; then
          echo "⚠️  Notarization credentials not found - skipping notarization"
          echo "   DMG may show 'damaged' error on other Macs"
          exit 0
        fi

        echo "Submitting DMG for notarization..."

        # Submit for notarization and capture the output
        xcrun notarytool submit "$DMG_PATH" \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_APP_SPECIFIC_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --wait 2>&1 | tee notary_output.txt

        # Check if notarization was accepted
        if grep -q "status: Accepted" notary_output.txt; then
          echo "✓ Notarization successful"

          # Staple the notarization ticket to the DMG
          echo "Stapling notarization ticket..."
          xcrun stapler staple "$DMG_PATH"
          echo "✓ DMG notarized and stapled"
        else
          echo "⚠️  Notarization failed or returned Invalid status"
          echo "   DMG is code-signed but not notarized - may show warning on first open"
          echo "   Users can right-click > Open to bypass the warning"
          exit 0
        fi

    - name: Import Sparkle signing key
      env:
        SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
      run: |
        # Import the EdDSA private key into the keychain for signing the appcast
        if [ -n "$SPARKLE_PRIVATE_KEY" ]; then
          security add-generic-password \
            -a "ed25519" \
            -s "https://sparkle-project.org" \
            -w "$SPARKLE_PRIVATE_KEY" \
            -D "Private key for signing Sparkle updates" \
            -T /usr/local/bin/generate_appcast \
            build.keychain
          echo "✓ Sparkle signing key imported"
        else
          echo "⚠️  Warning: SPARKLE_PRIVATE_KEY not set - appcast will not be signed"
        fi

    - name: Generate Appcast
      continue-on-error: true
      timeout-minutes: 1
      working-directory: MCPServerManager/build
      env:
        REPO: ${{ github.repository }}
        RUN_NUMBER: ${{ github.run_number }}
      run: |
        # Skip appcast generation for now - it's hanging in CI
        # TODO: Debug why generate_appcast hangs
        echo "⚠️  Skipping appcast generation (hangs in CI)"
        echo "Creating placeholder appcast.xml..."

        VERSION="2.0.2.${RUN_NUMBER}"
        PUBDATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")

        # Create appcast.xml manually to avoid YAML parsing issues with heredoc
        echo '<?xml version="1.0" encoding="utf-8"?>' > appcast.xml
        echo '<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">' >> appcast.xml
        echo '  <channel>' >> appcast.xml
        echo '    <title>MCP Server Manager</title>' >> appcast.xml
        echo '    <language>en</language>' >> appcast.xml
        echo '    <item>' >> appcast.xml
        echo "      <title>Version ${VERSION}</title>" >> appcast.xml
        echo "      <pubDate>${PUBDATE}</pubDate>" >> appcast.xml
        echo "      <sparkle:version>${VERSION}</sparkle:version>" >> appcast.xml
        echo '      <sparkle:shortVersionString>2.0.2</sparkle:shortVersionString>' >> appcast.xml
        echo "      <link>https://github.com/${REPO}/releases</link>" >> appcast.xml
        echo '      <description>Latest release of MCP Server Manager</description>' >> appcast.xml
        echo "      <enclosure url=\"https://github.com/${REPO}/releases/download/latest/MCP-Server-Manager-v${VERSION}.dmg\"" >> appcast.xml
        echo '                 type="application/octet-stream"/>' >> appcast.xml
        echo '    </item>' >> appcast.xml
        echo '  </channel>' >> appcast.xml
        echo '</rss>' >> appcast.xml

        echo "✓ Placeholder appcast created"

    - name: List build artifacts
      run: |
        echo "Build directory contents:"
        ls -la MCPServerManager/build/ || echo "No build directory"
        find . -name "*.dmg" -type f || echo "No DMG files found"
        find . -name "*.app" -type d || echo "No APP bundles found"
        find . -name "appcast.xml" -type f || echo "No appcast.xml found"

    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: mcp-server-manager-v2.0.2.${{ github.run_number }}
        path: MCPServerManager/build/MCP-Server-Manager-v*.dmg
        retention-days: 30

    - name: Delete old latest release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/swifty'
      run: |
        gh release delete latest -y || true
        git push origin :refs/tags/latest || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/swifty'
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest' }}
        name: ${{ startsWith(github.ref, 'refs/tags/') && format('Release {0}', github.ref_name) || format('Latest Build v2.0.2.{0}', github.run_number) }}
        body: |
          Version: 2.0.2.${{ github.run_number }}
          Commit: ${{ github.sha }}
        generate_release_notes: ${{ startsWith(github.ref, 'refs/tags/') }}
        prerelease: false
        files: |
          MCPServerManager/build/MCP-Server-Manager-v*.dmg
          MCPServerManager/build/appcast.xml
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
