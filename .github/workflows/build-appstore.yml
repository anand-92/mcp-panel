name: Build for Mac App Store

on:
  workflow_dispatch:
    inputs:
      upload_to_appstore:
        description: 'Upload to App Store Connect after build'
        required: false
        type: boolean
        default: true
  push:
    branches:
      - main
      - swifty
    tags:
      - 'appstore-v*'

jobs:
  build-appstore:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Install xcodegen
      run: brew install xcodegen

    - name: Import certificates
      env:
        MAC_APP_STORE_CERT: ${{ secrets.MAC_APP_STORE_CERT }}
        MAC_INSTALLER_CERT: ${{ secrets.MAC_INSTALLER_CERT }}
      run: |
        # Create temporary keychain
        security create-keychain -p actions build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p actions build.keychain
        security set-keychain-settings -t 3600 -u build.keychain

        # Decode and import App Store signing certificate (no password)
        echo "$MAC_APP_STORE_CERT" | base64 --decode > appstore_cert.p12
        security import appstore_cert.p12 -k build.keychain -P "" -T /usr/bin/codesign -T /usr/bin/productsign -A

        # Decode and import Installer certificate (no password)
        echo "$MAC_INSTALLER_CERT" | base64 --decode > installer_cert.p12
        security import installer_cert.p12 -k build.keychain -P "" -T /usr/bin/codesign -T /usr/bin/productsign -A

        # Set partition list
        security set-key-partition-list -S apple-tool:,apple:,codesign:,productsign: -s -k actions build.keychain

        # Verify certificates
        echo "Imported certificates:"
        security find-identity -v -p codesigning

        # Clean up
        rm appstore_cert.p12 installer_cert.p12

    - name: Create App Store project.yml (no Sparkle)
      run: |
        # Create a modified project.yml for App Store (removes Sparkle dependency)
        cat > project-appstore.yml << 'EOF'
        name: MCPServerManager
        options:
          bundleIdPrefix: com.mcpmanager
          deploymentTarget:
            macOS: "13.0"
          xcodeVersion: "15.0"
          generateEmptyDirectories: true
          groupSortPosition: top

        settings:
          base:
            MARKETING_VERSION: "3.1.0"
            CURRENT_PROJECT_VERSION: "1"
            SWIFT_VERSION: "5.9"
            MACOSX_DEPLOYMENT_TARGET: "13.0"
            CODE_SIGN_STYLE: Manual
            DEVELOPMENT_TEAM: NW6B3R27LQ

        targets:
          MCPServerManager:
            type: application
            platform: macOS
            sources:
              - path: MCPServerManager/MCPServerManager
                excludes:
                  - "**/*.entitlements"
            settings:
              base:
                PRODUCT_BUNDLE_IDENTIFIER: com.mcpmanager.app
                INFOPLIST_FILE: MCPServerManager/MCPServerManager/Info.plist
                CODE_SIGN_ENTITLEMENTS: MCPServerManager/MCPServerManager/MCPServerManager.entitlements
                ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
                ENABLE_HARDENED_RUNTIME: YES
                COMBINE_HIDPI_IMAGES: YES
                CODE_SIGN_IDENTITY: "3rd Party Mac Developer Application"
                PROVISIONING_PROFILE_SPECIFIER: ""
                LD_RUNPATH_SEARCH_PATHS:
                  - $(inherited)
                  - "@executable_path/../Frameworks"
            dependencies:
              - sdk: WidgetKit.framework
              - sdk: SwiftUI.framework
              - target: MCPServerManagerWidget
                embed: true
                codeSign: true
                buildPhase:
                  copyFiles:
                    destination: plugins
            entitlements:
              path: MCPServerManager/MCPServerManager/MCPServerManager.entitlements

          MCPServerManagerWidget:
            type: app-extension
            platform: macOS
            sources:
              - path: MCPServerManagerWidget
                excludes:
                  - "**/*.entitlements"
                  - "**/*.md"
            settings:
              base:
                PRODUCT_BUNDLE_IDENTIFIER: com.mcpmanager.app.widget
                INFOPLIST_FILE: MCPServerManagerWidget/Info.plist
                CODE_SIGN_ENTITLEMENTS: MCPServerManagerWidget/MCPServerManagerWidget.entitlements
                SKIP_INSTALL: YES
                CODE_SIGN_IDENTITY: "3rd Party Mac Developer Application"
                PROVISIONING_PROFILE_SPECIFIER: ""
                LD_RUNPATH_SEARCH_PATHS:
                  - $(inherited)
                  - "@executable_path/../Frameworks"
                  - "@executable_path/../../../../Frameworks"
            dependencies:
              - sdk: WidgetKit.framework
              - sdk: SwiftUI.framework
              - sdk: AppIntents.framework
            entitlements:
              path: MCPServerManagerWidget/MCPServerManagerWidget.entitlements

        schemes:
          MCPServerManager:
            build:
              targets:
                MCPServerManager: all
                MCPServerManagerWidget: all
            run:
              config: Debug
            archive:
              config: Release
        EOF

    - name: Generate Xcode project and build for App Store
      run: |
        # Generate Xcode project from App Store project.yml (no Sparkle)
        xcodegen generate --spec project-appstore.yml
        echo "âœ… Xcode project generated for App Store"

        # Create App Store entitlements (stricter than DMG)
        cat > MCPServerManager/MCPServerManager/MCPServerManager.entitlements << 'ENTITLEMENTS'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>com.apple.security.app-sandbox</key>
            <true/>
            <key>com.apple.security.files.user-selected.read-write</key>
            <true/>
            <key>com.apple.security.application-groups</key>
            <array>
                <string>group.com.anand-92.mcp-panel</string>
            </array>
        </dict>
        </plist>
        ENTITLEMENTS

        cat > MCPServerManagerWidget/MCPServerManagerWidget.entitlements << 'ENTITLEMENTS'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>com.apple.security.app-sandbox</key>
            <true/>
            <key>com.apple.security.application-groups</key>
            <array>
                <string>group.com.anand-92.mcp-panel</string>
            </array>
        </dict>
        </plist>
        ENTITLEMENTS

        # Build with xcodebuild (includes widget extension, no code signing for now)
        xcodebuild -project MCPServerManager.xcodeproj \
          -scheme MCPServerManager \
          -configuration Release \
          -derivedDataPath build \
          CODE_SIGNING_ALLOWED=NO \
          build

        echo "âœ… Build completed with widget extension (no Sparkle)"

        # Verify Sparkle is NOT linked
        echo "Checking for Sparkle dependency..."
        if otool -L build/Build/Products/Release/MCPServerManager.app/Contents/MacOS/MCPServerManager | grep -i Sparkle; then
          echo "âš ï¸ Warning: Sparkle.framework found - this may cause issues for App Store"
        else
          echo "âœ… Confirmed: No Sparkle dependency in binary (as expected for App Store)"
        fi

    - name: Create .app bundle for App Store
      run: |
        # Auto-increment version based on run number (max 3 components for App Store)
        VERSION_NUMBER="3.1.${{ github.run_number }}"

        BUILD_DIR="MCPServerManager/build-appstore"
        APP_NAME="MCP Server Manager"
        APP_PATH="$BUILD_DIR/$APP_NAME.app"

        # Create structure
        mkdir -p "$BUILD_DIR"

        # Copy built app
        cp -R build/Build/Products/Release/MCPServerManager.app "$APP_PATH"

        # Copy app icon
        cp MCPServerManager/icons/AppIcon.icns "$APP_PATH/Contents/Resources/AppIcon.icns"

        # Copy provisioning profile
        cp embedded.provisionprofile "$APP_PATH/Contents/embedded.provisionprofile"

        # Update Info.plist with version
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION_NUMBER" "$APP_PATH/Contents/Info.plist"
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ github.run_number }}" "$APP_PATH/Contents/Info.plist"
        /usr/libexec/PlistBuddy -c "Add :LSApplicationCategoryType string public.app-category.developer-tools" "$APP_PATH/Contents/Info.plist" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :NSHumanReadableCopyright string 'Copyright Â© 2025 Nikhil Anand. All rights reserved.'" "$APP_PATH/Contents/Info.plist" 2>/dev/null || true

        # Verify widget is embedded
        if [ -d "$APP_PATH/Contents/PlugIns/MCPServerManagerWidget.appex" ]; then
          echo "âœ… Widget extension embedded successfully"
        else
          echo "âš ï¸ Widget extension not found in app bundle"
        fi

        echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_ENV

    - name: Sign app bundle
      run: |
        BUILD_DIR="MCPServerManager/build-appstore"
        APP_NAME="MCP Server Manager"
        APP_PATH="$BUILD_DIR/$APP_NAME.app"

        # Find signing identity
        APP_SIGNING_IDENTITY=$(security find-identity -v -p codesigning | grep "3rd Party Mac Developer Application" | head -1 | awk -F'"' '{print $2}')

        echo "Signing with: $APP_SIGNING_IDENTITY"

        # Sign the widget extension first
        if [ -d "$APP_PATH/Contents/PlugIns/MCPServerManagerWidget.appex" ]; then
          codesign --deep --force --sign "$APP_SIGNING_IDENTITY" \
            --entitlements MCPServerManagerWidget/MCPServerManagerWidget.entitlements \
            --options runtime \
            --timestamp \
            "$APP_PATH/Contents/PlugIns/MCPServerManagerWidget.appex"
          echo "âœ… Widget extension signed"
        fi

        # Sign the main app
        codesign --deep --force --sign "$APP_SIGNING_IDENTITY" \
          --entitlements appstore.entitlements \
          --options runtime \
          --timestamp \
          "$APP_PATH"

        # Verify
        codesign --verify --deep --strict --verbose=2 "$APP_PATH"
        echo "âœ… App bundle signed successfully"

    - name: Create PKG installer
      run: |
        BUILD_DIR="MCPServerManager/build-appstore"
        APP_NAME="MCP Server Manager"
        APP_PATH="$BUILD_DIR/$APP_NAME.app"
        PKG_PATH="$BUILD_DIR/MCPServerManager-v${VERSION_NUMBER}.pkg"

        # Find installer identity (search all identities, not just codesigning)
        INSTALLER_IDENTITY=$(security find-identity -v | grep "3rd Party Mac Developer Installer" | head -1 | awk -F'"' '{print $2}')

        echo "Creating PKG with: $INSTALLER_IDENTITY"

        # Create PKG
        productbuild --component "$APP_PATH" /Applications \
          --sign "$INSTALLER_IDENTITY" \
          "$PKG_PATH"

        # Verify
        pkgutil --check-signature "$PKG_PATH"
        echo "âœ… PKG created successfully"

        echo "PKG_PATH=$PKG_PATH" >> $GITHUB_ENV

    - name: Upload PKG artifact
      uses: actions/upload-artifact@v4
      with:
        name: mcp-server-manager-appstore-${{ env.VERSION_NUMBER }}
        path: MCPServerManager/build-appstore/*.pkg
        retention-days: 90

    - name: Upload to App Store Connect
      if: github.event.inputs.upload_to_appstore == 'true' || startsWith(github.ref, 'refs/tags/appstore-v') || github.event_name == 'push'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        echo "ðŸ“¤ Uploading to App Store Connect..."

        # Use altool to upload the package
        xcrun altool --upload-package "$PKG_PATH" \
          --type macos \
          --username "$APPLE_ID" \
          --password "$APPLE_APP_SPECIFIC_PASSWORD" \
          --verbose

        echo "âœ… Upload complete! Check App Store Connect for processing status."
        echo "ðŸ”— https://appstoreconnect.apple.com/apps"

    # NOTE: We do NOT create GitHub releases for App Store builds
    # App Store PKGs should only be uploaded to App Store Connect
    # They cannot be installed without App Store approval
    # Artifacts are available in Actions for 90 days for internal use

    - name: Cleanup keychain
      if: always()
      run: |
        security delete-keychain build.keychain || true
