#!/bin/bash
# Pre-commit hook to remind about CHANGELOG.md updates

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Check if we're in the middle of a rebase/merge
if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ] || [ -f ".git/MERGE_HEAD" ]; then
    exit 0
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if there are any Swift or code files being committed
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(swift|sh|yml|yaml|json|toml)$' | grep -v CHANGELOG.md)

# Check if CHANGELOG.md is being modified
CHANGELOG_MODIFIED=$(echo "$STAGED_FILES" | grep -E '^CHANGELOG\.md$')

# If code files are being committed but CHANGELOG.md is not modified
if [ -n "$CODE_FILES" ] && [ -z "$CHANGELOG_MODIFIED" ]; then
    echo ""
    echo -e "${YELLOW}⚠️  CHANGELOG REMINDER${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "You're committing code changes without updating CHANGELOG.md"
    echo ""
    echo "Code files being committed:"
    echo "$CODE_FILES" | sed 's/^/  - /'
    echo ""
    echo -e "${YELLOW}Did you forget to update the changelog?${NC}"
    echo ""
    echo "If this commit has user-facing changes:"
    echo -e "  ${GREEN}1.${NC} Add your changes to the [Unreleased] section in CHANGELOG.md"
    echo -e "  ${GREEN}2.${NC} Stage the changelog: git add CHANGELOG.md"
    echo -e "  ${GREEN}3.${NC} Retry your commit"
    echo ""
    echo "If this is just internal refactoring or non-user-facing:"
    echo -e "  ${GREEN}→${NC} You can proceed with this commit"
    echo ""
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Ask user if they want to continue
    echo -n -e "${YELLOW}Continue without updating CHANGELOG.md? [y/N]:${NC} "
    read -r response

    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo ""
        echo -e "${RED}Commit aborted. Please update CHANGELOG.md and try again.${NC}"
        echo ""
        exit 1
    fi

    echo ""
    echo -e "${GREEN}✓ Proceeding with commit (changelog not updated)${NC}"
    echo ""
fi

exit 0
